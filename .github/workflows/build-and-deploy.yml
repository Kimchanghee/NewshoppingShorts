name: Build and Deploy

on:
  push:
    tags:
      - 'v*'  # v1.0.2, v1.1.0 등 버전 태그 푸시 시 실행

permissions:
  contents: write
jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.14
      uses: actions/setup-python@v5
      with:
        python-version: '3.14'

    - name: Cache pip packages
      uses: actions/cache@v4
      with:
        path: ~\AppData\Local\pip\Cache
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        python -m pip install -r requirements.txt
        python -m pip install pyinstaller
        python -c "import sys; import PyInstaller; print('python=', sys.executable); print('pyinstaller=', PyInstaller.__version__)"

    - name: Install Inno Setup
      run: choco install innosetup --no-progress -y

    - name: Install Tesseract OCR
          run: choco install tesseract --no-progress -y

    - name: Download Whisper models
      run: python scripts/download_whisper_models.py
      continue-on-error: true
      timeout-minutes: 10

    - name: Extract version from tag
      id: version
      shell: bash
      run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

    - name: Update version.json
      shell: python
      run: |
        import json
        from datetime import date
        from pathlib import Path
        version = "${{ steps.version.outputs.VERSION }}"
        p = Path("version.json")
        data = {}
        if p.exists():
            try:
                data = json.loads(p.read_text(encoding="utf-8"))
            except Exception:
                data = {}
        data["version"] = version
        data.setdefault("min_required_version", "1.0.0")
        data.setdefault("update_channel", "stable")
        data.setdefault("build_date", date.today().isoformat())
        data["updated_at"] = date.today().isoformat()
        p.write_text(json.dumps(data, ensure_ascii=False, indent=2), encoding="utf-8")
        print(f"Updated version.json to {version}")

    - name: Build Installer
      shell: pwsh
      run: |
        ./scripts/build_exe.ps1

    - name: Compute installer SHA256
      id: hash
      shell: pwsh
      run: |
        $version = "${{ steps.version.outputs.VERSION }}"
        $installer = "dist/SSMaker_Setup_v${version}.exe"
        $hash = (Get-FileHash -Path $installer -Algorithm SHA256).Hash.ToLower()
        Write-Host "SHA256: $hash"
        echo "FILE_HASH=$hash" >> $env:GITHUB_OUTPUT

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: dist/SSMaker_Setup_v${{ steps.version.outputs.VERSION }}.exe
        name: Release v${{ steps.version.outputs.VERSION }}
        body: |
          ## SSMaker v${{ steps.version.outputs.VERSION }}

          ### 변경 사항
          - 자동 빌드된 버전입니다.

          ### 다운로드
          아래 설치 파일을 다운로드하여 실행하세요.

          ### SHA256
          `${{ steps.hash.outputs.FILE_HASH }}`
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Update server version API
      run: |
        $version = "${{ steps.version.outputs.VERSION }}"
        $downloadUrl = "https://github.com/${{ github.repository }}/releases/download/v${version}/SSMaker_Setup_v${version}.exe"

        $body = @{
          version = $version
          download_url = $downloadUrl
          file_hash = "${{ steps.hash.outputs.FILE_HASH }}"
          release_notes = "버전 ${version} 자동 배포"
          is_mandatory = $false
        } | ConvertTo-Json

        try {
          Invoke-RestMethod -Uri "https://ssmaker-auth-api-1049571775048.us-central1.run.app/app/version/update" `
            -Method POST `
            -Headers @{
              "Content-Type" = "application/json"
              "Authorization" = "Bearer ${{ secrets.ADMIN_API_KEY }}"
            } `
            -Body $body
          Write-Host "Server version updated successfully"
        } catch {
          Write-Host "Warning: Failed to update server version API"
          Write-Host $_.Exception.Message
        }
